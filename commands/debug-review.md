---
description: 陰湿なレビューで問題点を炙り出す - コードを深く考えさせる触媒
allowed-tools:
  - Read
  - Glob
  - Grep
  - Bash
  - Write
  - Edit
  - mcp__serena__*
---

# デバッグレビュー (/debug-review)

## Philosophy（なぜこの手法を取るのか）

```
1. 不具合は意図の判らないコードで起きやすい
2. 陰湿な質問は、コードを深く考えさせる触媒として機能する
3. 質問に答えようとする過程で、問題点が浮かび上がる
```

**重要な区別**:
- これは「仮説を立てて検証する」調査手法ではない
- これは「回答能力のテスト」ではない
- 質問という触媒を通じて、問題点を発見する手法である

質問に対して「説明できる/できない」は関係ない。
質問と回答の**内容**から、問題点が浮かび上がる。

## セルフレビューとの違い

| 観点 | セルフレビュー | デバッグレビュー |
|------|--------------|-----------------|
| **対象** | 変更（diff） | 既存コード（問題が疑われる箇所） |
| **目的** | 変更の妥当性を確認 | 問題点を炙り出す |
| **入力** | git diff | ファイル/関数 + 症状（任意） |

## 2段階構造の理由

| Phase | 担当 | 役割 |
|-------|------|------|
| **1** | ストラクチャさん | どこを突くかの「地図」を作る |
| **2** | フラットさん | 地図上の経路を陰湿に突く（触媒） |

構造を把握せずに質問しても、的外れになる。
構造分析は質問の精度を上げるための前処理である。

## エージェント定義

| エージェント | 役割 | 定義ファイル |
|-------------|------|-------------|
| ストラクチャさん | 構造・呼び出し関係・データフロー | `~/.claude/agents/structure-reviewer.md` |
| フラットさん | 陰湿な質問（触媒） | `~/.claude/agents/flat-reviewer.md` |

**注意**: コンテキストさんは使用しない。問題調査では「コードだけを見る」視点が重要。

## コマンド引数の解釈

ユーザーの入力: `$ARGUMENTS`

### 対象の決定

1. **ファイルパス**: 指定されたファイル/ディレクトリを対象
2. **関数名**: 指定された関数とその周辺を対象
3. **症状の記述**: 問題の症状を参考情報として記録（調査対象の絞り込みに使用）

**例**:
- `/debug-review src/body_control/actuator_control.cpp`
- `/debug-review ActuatorControl::is_loaded_at_limit`
- `/debug-review actuator_control.cpp "gripper_engaged_がtrueにならない"`

## 実行フロー

### Step 1: 対象の特定と確認

```
デバッグレビューを開始します。

対象: [ファイル/関数]
症状: [あれば記載]

この対象に対して陰湿な質問を投げ、問題点を炙り出します。
よろしいですか？
```

### Step 2: レビュー記録の初期化

保存先: `tmp/debug-reviews/YYYYMMDD_HHMMSS_<識別子>.md`

```markdown
# Debug Review Record

## メタ情報
- 作成日時: YYYY-MM-DD HH:MM
- 対象: [ファイル/関数]
- 症状: [あれば]

## Phase 1: 構造分析
（待機中）

## Phase 2: 陰湿な質問
（待機中）
```

### Step 3: Phase 1 - 構造分析（地図作成）

**ストラクチャさん**をSubAgentとして起動。

```
Task: structure-reviewer
目的: 問題が潜んでいる可能性のある経路を特定する

入力:
  - 対象コード
  - 症状（あれば）

出力:
  - 呼び出し関係図
  - データフロー
  - 状態遷移
  - 注目すべき経路
```

**構造分析の結果をユーザーに提示**:
- 「この経路に問題が潜んでいる可能性があります」
- 「以下のデータフローを重点的に見ます」

### Step 4: Phase 2 - 陰湿な質問（触媒）

**フラットさん**をSubAgentとして起動。

```
Task: flat-reviewer
目的: 構造分析で特定された経路に対して陰湿な質問を投げる

入力:
  - 対象コード
  - Phase 1で特定された注目経路
  - 症状（あれば）

出力:
  - 陰湿な質問リスト
```

**質問のトーン例**:
- 「この変数、いつ初期化されますか？」
- 「このバッファ、クリアされるタイミングは？」
- 「この条件、境界値では大丈夫ですか？」
- 「このmutex、範囲は適切ですか？」

### Step 5: 回答の記録と判定

ユーザーの回答を受けて：

1. レビュー記録に回答を追記
2. 判定を付与:
   - **問題発見**: 回答の中で問題点が見つかった
   - **説明可能**: 問題点は見つからなかった
   - **要追加調査**: 判断に追加情報が必要
3. 必要に応じて追加質問（深掘り）

**重要**: 「説明できる/できない」ではなく、回答の**内容**から判定する。

### Step 6: サマリー

```markdown
## サマリー

### 発見された問題点

| # | 箇所 | 内容 | 重要度 |
|---|------|------|--------|
| 1 | ... | ... | 高/中/低 |

### 追加調査が必要な項目

| # | 箇所 | 確認事項 |
|---|------|----------|
| 1 | ... | ... |
```

## 出力フォーマット

### 質問提示時

```markdown
## Phase 2: 陰湿な質問

構造分析の結果、以下の経路に注目します：
- [経路1の説明]
- [経路2の説明]

---

### Q1: [質問タイトル]

**位置:** `[ファイルパス]:[行番号]`

**コード:**
```cpp
[該当コード]
```

**質問:**
[陰湿な質問]

---

上記について説明をお願いします。
```

### レビュー記録のフォーマット

```markdown
### Q1: [質問タイトル]

**位置:** `[ファイルパス]:[行番号]`

**コード:**
```cpp
[該当コード]
```

**質問:**
[質問内容]

**回答:**
[ユーザーの回答]

**判定:** [問題発見 / 説明可能 / 要追加調査]

**発見された問題:**（問題発見の場合）
[具体的な問題点]
```

## 注意事項

- 質問は「テスト」ではなく「触媒」である
- ユーザーの回答を深く聞き、問題点を一緒に発見する姿勢
- 「説明できない」ことを責めるのではなく、問題発見の機会とする
- レビュー記録は必ず `tmp/debug-reviews/` に保存する
